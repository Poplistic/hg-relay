<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Hunger Games Arena Map</title>

<style>
	body {
		margin: 0;
		overflow: hidden;
		background: radial-gradient(#050505, #000);
		font-family: Arial, sans-serif;
	}

	.label {
		position: absolute;
		color: #fff;
		font-size: 12px;
		text-align: center;
		pointer-events: none;
		text-shadow:
			0 0 6px #ff4444,
			0 0 12px #ff0000;
		transform: translate(-50%, -50%);
	}
</style>
</head>

<body>

<script type="module">
import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js";
import { OrbitControls } from "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/controls/OrbitControls.js";
import { OBJLoader } from "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/loaders/OBJLoader.js";

/* ======================
   SCENE
====================== */

const scene = new THREE.Scene();
scene.fog = new THREE.Fog(0x000000, 800, 4000);

const camera = new THREE.PerspectiveCamera(60, innerWidth / innerHeight, 1, 8000);
camera.position.set(0, 900, 1400);

/* ======================
   RENDERER
====================== */

const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(innerWidth, innerHeight);
renderer.setPixelRatio(devicePixelRatio);
document.body.appendChild(renderer.domElement);

/* ======================
   CONTROLS
====================== */

const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;
controls.dampingFactor = 0.05;
controls.screenSpacePanning = true;
controls.minDistance = 400;
controls.maxDistance = 3000;
controls.maxPolarAngle = Math.PI / 2.1;

/* ======================
   LIGHTING
====================== */

scene.add(new THREE.AmbientLight(0x666666));

const sun = new THREE.DirectionalLight(0xffffff, 1.2);
sun.position.set(800, 1500, 600);
scene.add(sun);

/* ======================
   ARENA OBJ MAP
====================== */

const loader = new OBJLoader();
loader.load("/arena.obj", obj => {
	obj.traverse(m => {
		if (m.isMesh) {
			m.material = new THREE.MeshStandardMaterial({
				color: 0x2a2a2a,
				roughness: 0.8,
				metalness: 0.2
			});
			m.castShadow = true;
			m.receiveShadow = true;
		}
	});

	obj.scale.set(20, 20, 20); // adjust if needed
	obj.position.y = 0;
	scene.add(obj);
});

/* ======================
   PLAYER MARKERS
====================== */

const markers = new Map();

function createMarker(player) {
	const group = new THREE.Group();

	// Glow core
	const core = new THREE.Mesh(
		new THREE.SphereGeometry(10, 16, 16),
		new THREE.MeshBasicMaterial({ color: 0xff3333 })
	);
	group.add(core);

	// Outer glow
	const glow = new THREE.Mesh(
		new THREE.SphereGeometry(18, 16, 16),
		new THREE.MeshBasicMaterial({
			color: 0xff0000,
			transparent: true,
			opacity: 0.35
		})
	);
	group.add(glow);

	const label = document.createElement("div");
	label.className = "label";
	label.innerHTML = `<b>D${player.district}</b><br>${player.name}`;
	document.body.appendChild(label);

	scene.add(group);
	markers.set(player.userId, { group, label, glow });
}

/* ======================
   UPDATE PLAYERS
====================== */

async function updatePlayers() {
	const res = await fetch("/map");
	const players = await res.json();

	for (const p of players) {
		if (!markers.has(p.userId)) createMarker(p);

		const { group, label } = markers.get(p.userId);

		group.position.set(p.x, 15, p.z);

		const screenPos = group.position.clone().project(camera);
		label.style.left = ((screenPos.x + 1) / 2 * innerWidth) + "px";
		label.style.top = ((-screenPos.y + 1) / 2 * innerHeight) + "px";
	}
}

/* ======================
   ANIMATION LOOP
====================== */

function animate() {
	controls.update();

	// Glow pulse
	const pulse = 1 + Math.sin(Date.now() * 0.004) * 0.25;
	for (const m of markers.values()) {
		m.glow.scale.set(pulse, pulse, pulse);
	}

	renderer.render(scene, camera);
}

/* ======================
   RESIZE
====================== */

window.addEventListener("resize", () => {
	camera.aspect = innerWidth / innerHeight;
	camera.updateProjectionMatrix();
	renderer.setSize(innerWidth, innerHeight);
});

/* ======================
   START
====================== */

setInterval(updatePlayers, 250);
renderer.setAnimationLoop(animate);
</script>

</body>
</html>
