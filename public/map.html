<script type="module">
import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js";
import { OrbitControls } from "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/controls/OrbitControls.js";
import { Sky } from "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/objects/Sky.js";

/* ======================
   RENDERER
====================== */

const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(innerWidth, innerHeight);
renderer.setPixelRatio(devicePixelRatio);
renderer.outputColorSpace = THREE.SRGBColorSpace;
renderer.toneMapping = THREE.ACESFilmicToneMapping;
renderer.toneMappingExposure = 1.1;
document.body.appendChild(renderer.domElement);

/* ======================
   SCENE / CAMERA
====================== */

const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(60, innerWidth / innerHeight, 1, 10000);
camera.position.set(2000, 1600, 2000);

new OrbitControls(camera, renderer.domElement);

/* ======================
   PHYSICAL SKY
====================== */

const sky = new Sky();
sky.scale.setScalar(10000);
scene.add(sky);

const sun = new THREE.Vector3();
const skyU = sky.material.uniforms;
skyU.turbidity.value = 10;
skyU.rayleigh.value = 2;
skyU.mieCoefficient.value = 0.005;
skyU.mieDirectionalG.value = 0.8;

/* ======================
   LIGHTS
====================== */

const dirLight = new THREE.DirectionalLight(0xffffff, 3);
scene.add(dirLight);
scene.add(new THREE.AmbientLight(0x404060, 0.4));

/* ======================
   PLAYERS
====================== */

const playerGroup = new THREE.Group();
scene.add(playerGroup);

function makePlayerDot() {
	const canvas = document.createElement("canvas");
	canvas.width = 128;
	canvas.height = 32;
	const ctx = canvas.getContext("2d");

	const tex = new THREE.CanvasTexture(canvas);
	const mat = new THREE.SpriteMaterial({ map: tex, transparent: true });
	const sprite = new THREE.Sprite(mat);
	sprite.scale.set(120, 30, 1);
	sprite.userData.ctx = ctx;
	sprite.userData.tex = tex;
	return sprite;
}

const playerSprites = new Map();

function updatePlayers(data) {
	for (const p of data) {
		if (!playerSprites.has(p.id)) {
			const s = makePlayerDot();
			playerGroup.add(s);
			playerSprites.set(p.id, s);
		}
		const s = playerSprites.get(p.id);
		s.position.set(p.x, 50, p.z);

		const ctx = s.userData.ctx;
		ctx.clearRect(0, 0, 128, 32);
		ctx.fillStyle = "#000";
		ctx.fillRect(0, 0, 128, 32);
		ctx.fillStyle = "#0f0";
		ctx.fillRect(2, 2, (p.health / p.maxHealth) * 124, 28);
		s.userData.tex.needsUpdate = true;
	}
}

/* ======================
   FETCH LOOP
====================== */

let lighting = null;

setInterval(async () => {
	updatePlayers(await fetch("/map").then(r => r.json()));
	lighting = await fetch("/lighting").then(r => r.json());
}, 200);

/* ======================
   ANIMATE
====================== */

function animate() {
	requestAnimationFrame(animate);

	if (lighting) {
		sun.set(
			lighting.sunDirection[0],
			lighting.sunDirection[1],
			lighting.sunDirection[2]
		);

		sky.material.uniforms.sunPosition.value.copy(sun.multiplyScalar(5000));
		dirLight.position.copy(sun);
		dirLight.intensity = lighting.brightness * 1.2;
	}

	renderer.render(scene, camera);
}

animate();
</script>
