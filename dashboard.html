<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Sky Editor</title>

<style>
:root {
  --accent: #7aa2ff;
  --bg-glass: rgba(20, 24, 40, 0.65);
}

body {
  margin: 0;
  overflow: hidden;
  background: radial-gradient(circle at top, #0b1020, #000);
  color: white;
  font-family: system-ui, -apple-system, Segoe UI, sans-serif;
}

/* ---------- UI PANEL ---------- */
#ui {
  position: absolute;
  top: 16px;
  left: 16px;
  width: 280px;
  padding: 14px;
  background: var(--bg-glass);
  backdrop-filter: blur(14px) saturate(140%);
  border-radius: 16px;
  box-shadow:
    0 0 0 1px rgba(255,255,255,0.06),
    0 20px 40px rgba(0,0,0,0.6);
}

#ui hr {
  border: none;
  height: 1px;
  background: linear-gradient(to right, transparent, #ffffff22, transparent);
  margin: 10px 0;
}

label {
  font-size: 12px;
  opacity: 0.7;
}

input, select, button {
  width: 100%;
  margin-bottom: 8px;
  border-radius: 10px;
  border: none;
  outline: none;
  font-size: 13px;
}

input, select {
  padding: 6px 8px;
  background: rgba(255,255,255,0.08);
  color: white;
}

input[type="range"] { padding: 0; }

button {
  padding: 8px;
  background: linear-gradient(135deg, #4f6cff, #7aa2ff);
  color: white;
  cursor: pointer;
  font-weight: 600;
  box-shadow: 0 6px 14px rgba(80,120,255,0.35);
}

button:hover { filter: brightness(1.1); }

select { height: 80px; }

#preview {
  width: 100%;
  border-radius: 10px;
  margin-bottom: 8px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.5);
}
</style>
</head>

<body>

<div id="ui">
  <button onclick="undo()">Undo</button>
  <button onclick="redo()">Redo</button>

  <hr>

  <select id="list" size="4"></select>
  <button onclick="addObject()">Add Object</button>

  <hr>

  <label>Image ID</label>
  <input id="image">
  <img id="preview" style="display:none">

  <label>Text</label>
  <input id="text">

  <label>Yaw</label>
  <input id="yaw" type="range" min="-180" max="180">

  <label>Pitch</label>
  <input id="pitch" type="range" min="-10" max="80">

  <label>Radius</label>
  <input id="radius" type="range" min="400" max="1200">

  <label>Scale</label>
  <input id="scale" type="range" min="0.5" max="3" step="0.1">

  <button onclick="save()">Save</button>
</div>

<script type="module">
/* ---------- IMPORTS ---------- */
import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.module.js";
import { OrbitControls } from "https://cdn.jsdelivr.net/npm/three@0.158.0/examples/jsm/controls/OrbitControls.js";

/* ---------- SCENE ---------- */
const scene = new THREE.Scene();
scene.fog = new THREE.Fog(0x020409, 800, 2200);

const camera = new THREE.PerspectiveCamera(60, innerWidth / innerHeight, 1, 5000);
camera.position.set(0, 200, 600);

const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(innerWidth, innerHeight);
renderer.setPixelRatio(devicePixelRatio);
renderer.outputColorSpace = THREE.SRGBColorSpace;
renderer.setClearColor(0x020409, 1);
document.body.appendChild(renderer.domElement);

const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;

/* ---------- LIGHTING ---------- */
scene.add(new THREE.AmbientLight(0xffffff, 0.6));

const sun = new THREE.DirectionalLight(0x9bb4ff, 0.6);
sun.position.set(300, 400, 200);
scene.add(sun);

/* ---------- SKY DOME ---------- */
const sky = new THREE.Mesh(
  new THREE.SphereGeometry(2000, 48, 32),
  new THREE.ShaderMaterial({
    side: THREE.BackSide,
    uniforms: {
      top: { value: new THREE.Color(0x0b1430) },
      bottom: { value: new THREE.Color(0x020409) }
    },
    vertexShader: `
      varying vec3 vPos;
      void main(){
        vPos = position;
        gl_Position = projectionMatrix * modelViewMatrix * vec4(position,1.0);
      }
    `,
    fragmentShader: `
      uniform vec3 top;
      uniform vec3 bottom;
      varying vec3 vPos;
      void main(){
        float h = normalize(vPos).y * 0.5 + 0.5;
        gl_FragColor = vec4(mix(bottom, top, h), 1.0);
      }
    `
  })
);
scene.add(sky);

/* ---------- OBJECT SYSTEM ---------- */
let objects = [];
let selected = null;
let history = [];
let historyIndex = -1;

function snapshot() {
  const state = JSON.stringify(objects.map(o => o.data));
  if (history[historyIndex] === state) return;
  history = history.slice(0, historyIndex + 1);
  history.push(state);
  historyIndex++;
}

function restore(i) {
  objects.forEach(o => scene.remove(o.mesh));
  objects = [];

  JSON.parse(history[i]).forEach(d => {
    const mesh = new THREE.Mesh(
      new THREE.PlaneGeometry(200, 100),
      new THREE.MeshBasicMaterial({ transparent: true })
    );
    scene.add(mesh);
    objects.push({ data: d, mesh });
    updateMesh(objects.at(-1));
  });

  updateList();
  select(objects[0]?.data.id);
}

window.undo = () => historyIndex > 0 && restore(--historyIndex);
window.redo = () => historyIndex < history.length - 1 && restore(++historyIndex);

/* ---------- HELPERS ---------- */
function spherical(y, p, r) {
  y = THREE.MathUtils.degToRad(y);
  p = THREE.MathUtils.degToRad(p);
  return new THREE.Vector3(
    Math.cos(p) * Math.cos(y) * r,
    Math.sin(p) * r,
    Math.cos(p) * Math.sin(y) * r
  );
}

function thumb(id) {
  return `https://www.roblox.com/asset-thumbnail/image?assetId=${id.replace(/\D/g,"")}&width=420&height=420&format=png`;
}

/* ---------- UI ---------- */
window.addObject = () => {
  const d = { id: Date.now()+"", imageId:"", text:"", yaw:0, pitch:25, radius:800, scale:1 };
  const mesh = new THREE.Mesh(
    new THREE.PlaneGeometry(200,100),
    new THREE.MeshBasicMaterial({ transparent:true })
  );
  scene.add(mesh);
  objects.push({ data:d, mesh });
  updateList();
  select(d.id);
  snapshot();
};

function updateList(){
  list.innerHTML="";
  objects.forEach(o=>{
    const opt=document.createElement("option");
    opt.value=o.data.id;
    opt.text=o.data.id;
    list.appendChild(opt);
  });
}

function select(id){
  selected = objects.find(o=>o.data.id===id);
  list.value=id;
  syncUI();
}

function updateMesh(o){
  const d=o.data;
  const pos=spherical(d.yaw,d.pitch,d.radius);
  o.mesh.position.copy(pos);
  o.mesh.lookAt(0,pos.y,0);
  o.mesh.scale.setScalar(d.scale);
}

function syncUI(){
  if(!selected) return;
  const d=selected.data;
  image.value=d.imageId;
  text.value=d.text;
  yaw.value=d.yaw;
  pitch.value=d.pitch;
  radius.value=d.radius;
  scale.value=d.scale;

  if(d.imageId){
    preview.src=thumb(d.imageId);
    preview.style.display="block";
    selected.mesh.material.map=new THREE.TextureLoader().load(preview.src);
    selected.mesh.material.needsUpdate=true;
  }
}

[list,image,text,yaw,pitch,radius,scale].forEach(el=>{
  el.oninput=()=>{
    if(!selected) return;
    Object.assign(selected.data,{
      imageId:image.value,
      text:text.value,
      yaw:+yaw.value,
      pitch:+pitch.value,
      radius:+radius.value,
      scale:+scale.value
    });
    updateMesh(selected);
    snapshot();
  };
});

list.onchange=()=>select(list.value);

/* ---------- SAVE ---------- */
window.save = async () => {
  await fetch("https://games-k04d.onrender.com/sky",{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "Authorization":localStorage.getItem("token")
    },
    body:JSON.stringify(objects.map(o=>o.data))
  });
  alert("Saved");
};

/* ---------- LOOP ---------- */
function animate(){
  requestAnimationFrame(animate);
  controls.update();
  renderer.render(scene,camera);
}
animate();
</script>

</body>
</html>
